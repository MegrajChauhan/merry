# Cores

## Overview 

In this document and the following series of documents, I will be explaining the various rules for writing a core. If anyone is interested in writing a core, the series of documents will be exactly what you are looking for.You will also learn how cores work and are expected to work.

## The API

Graves expects the cores to follow a very basic set of rules. Anything that follows these rules is identified and treated as a core by Graves despite what it actually might be. Graves expects some functions from the cores
that are used to interact with the cores. These functions are given below:
```c
void * core_create (struct CoreBase *, address_t, struct ICRes *);
void  core_delete(void *);
size_t core_exec(void *);
struct CoreBase * create_base(struct ICRes *);
void delete_base(struct CoreBase *);
void pre_deletion(void *);
size_t set_input(void *, char *, struct ICRes *);
size_t prepare_core(void *, struct ICRes *);
result_t config_core(char *, const char*, unsigned char*);
```
I will be explaining each of these one by one but first you need to know about the structures used.

## How Graves treats core?

Gravess' view of a core is the **core representation** for the core. Graves defines a core using just the core representation. The core representation is something like:
```c
core_representation {
  struct CoreBase *base;
  void *core;
};
```

## The Basic Structure

The **struct CoreBase** is a set of properties common to all of the cores. Each core has full access to the base and it is recommended that the core doesn't mess with the values set by itself or Graves.
```c
CoreBase {
  corecreate_t createc; // function pointer to a function similar to core_create
  coredeletecore_t deletec; // function pointer to a function similar to core_delete
  coreexec_t execc; // function pointer to a function similar to core_exec
  corepredel_t predel; // function pointer to a function similar to pre_deletion
  coresetinp_t setinp; // function pointer to a function similar to set_input
  coreprepcore_t prepcore; // function pointer to a function similar to prepare_core

  bool_t running;   // core sets this to FALSE iff it has terminated
  bool_t interrupt; // set by Graves to interrupt the core prompting it to do something

  mid_t id; // an id assigned to the core by Graves 
  muid_t uid; // a unique id assigned to the core by Graves
  mguid_t guid; // the id of the group that the core belongs to
  core_t type; // the type of the core
};
```

The **struct ICRes** stands for **Inter-Core Result**. It represents the result of core creation. When one core makes a request to build another core, it will receive the result via ICRes and has to interpret it as needed.
```c
ICRes {
  ICResSource_t source; // The source of the result
  msize_t ERRNO; // If any errno needs to be transferred
  union {
    interfaceRet_t _interface_ret; // if the interface failed 
    result_t _merry_ret; // if merry failed 
    size_t _core_code; // core specific return value
  };
};
```

**result_t** will be defined in its own dedicated document as well as **interfaceRet_t**. **ICResSource_t** 
describes the source of the result. It can have the following values:
| Value | Numerically | Description |
| ----- | ----------- | ----------- |
| IC\_SOURCE\_INTERFACE | 0 | The failure occured whilst dealing with an interface |
| IC\_SOURCE\_MERRY | 1 | The failure occured because of Merry |
| IC\_SOURCE\_CORE | 2 | The failure occured within the core itself |

## Process of Creation

Graves first creates a base for the core. The core should initialize all of the function pointers and leave
everything else as is. The next step is the creation of the core by using the function provided as **createc**. Then **setinp** is called to set the input file for the core followed by the call to **prepcore** which should prepare the core for launch. Graves then boots the core and a call to execc is made. After that, the core is given all of the power.

## Process of Destruction

If a core encounters an internal error, it may terminate simply by returning from **execc**. Graves makes a call to **predel** to prepare for core deletion. **deletec** is called next to free all of the resources allocated by the core. The core should not free the **CoreBase** that it saves internally. The next call deletes the base of the core and the termination is completed.

## So?

This is the basic interface between Graves and the cores. The cores have to do much more and requests are still left but this covers the basic.
