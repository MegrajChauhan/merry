# Graves-Core Communication

## Overview

The interface described in **4.md** is used by Graves to interact with the cores and is limited to just that
but cores must talk to Graves for a variety of things. To facillitate the communication between cores and Graves, Graves uses **requests** and **request queue**. A core pushes its request to the **request queue** via the **request queue manager** and can either wait for the request to be fulfilled or continue without stopping.

## Why Requests?

This is a very real question. The cores have unlimited power really- they can use **exit()**, **abort()** or any other functions to terminate the entire process, spawn thousands of threads or processes to absolutely obliterate the system and the list goes on and on and on. Graves really has no power over what the cores might do and hence comes the rules of Merry- **absolute trust**. Only trusted and tested cores will be allowed to join the Merry ecosystem. What is allowed and what is not will be covered as we get there. Since the trust ensures that Merry remains a stable ecosystem, the cores need a way to communicate with Graves, hence, **requests** were created.

## What is a Request?

A request looks something like this:
```c
GravesRequest {
  request_type type; // the type of request
  _Atomic bool_t fufilled; // is the request fulfilled?
  struct CoreBase *base; // the base of the core 
  cond_t *used_cond; // the condition variable used for this request
  RequestArgs *args; // arguments for the request 
  GravesRequestOperationResult result;  // the result of the request
};
```

**request_type** will get its own dedicated document but lets explore the rest of the structures.
```c
GravesRequestOperationResult {
  result_t result; // The result of the request
  size_t ERRNO; // any errno if required
  ICRes ic_res; // IC result if required
};
```

**RequestArgs** is quite large to explain and hence there are setter and getter functions for every single request type to successfully send requests and get results. These functions will be explored in their own document.

## How is a request made?

The **request queue manager** provides two different functions for the purpose:

```c
result SEND_REQUEST(GravesRequest *);
result_t SEND_REQUEST_async(GravesRequest *);
```

**SEND_REQUEST** waits for the request to be fulfilled before returning while **SEND_REQUEST_async** doesn't.
